input {
  file {
    path => "/var/log/heralding/heralding.log"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    codec => json
    type => "heralding"
  }
}

filter {
  if [type] == "heralding" {
    # Convertir le timestamp Heralding
    date {
      match => [ "timestamp", "ISO8601", "yyyy-MM-dd HH:mm:ss.SSSSSS", "yyyy-MM-dd'T'HH:mm:ss.SSSSSSZ" ]
      target => "@timestamp"
    }

    # Normaliser le nom du champ IP source
    # Heralding peut utiliser "source_ip" ou "src_ip"
    if [source_ip] and ![src_ip] {
      mutate {
        add_field => { "src_ip" => "%{source_ip}" }
      }
    }

    # Extraire la gÃ©olocalisation de l'IP source
    if [src_ip] {
      geoip {
        source => "src_ip"
        target => "geoip"
      }
    }

    # Ajouter des tags selon le protocole
    if [protocol] {
      mutate {
        add_tag => ["protocol_%{protocol}"]
      }
    }

    # Tags pour les authentifications
    if [auth_result] == "success" or [authentication] == "success" {
      mutate {
        add_tag => ["auth_success"]
      }
    } else if [auth_result] == "failed" or [authentication] == "failed" {
      mutate {
        add_tag => ["auth_failed"]
      }
    }

    # Tag pour les nouvelles connexions
    if [eventid] == "heralding.session.connect" or [event] == "connect" {
      mutate {
        add_tag => ["new_connection"]
      }
    }

    # Normaliser le champ username
    if [user] and ![username] {
      mutate {
        add_field => { "username" => "%{user}" }
      }
    }

    # Normaliser le champ password
    if [pass] and ![password] {
      mutate {
        add_field => { "password" => "%{pass}" }
      }
    }

    # Nettoyer les champs inutiles
    mutate {
      remove_field => ["host", "path", "source_ip", "user", "pass"]
    }
  }
}

output {
  if [type] == "heralding" {
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      index => "heralding-%{+YYYY.MM.dd}"
      document_type => "_doc"
    }
    
    # Debug: afficher les logs dans la console
    stdout {
      codec => rubydebug
    }
  }
}